<%#
 Copyright 2024 the original author or authors from the JHipster project.

 This file is part of the JHipster project, see https://www.jhipster.tech/
 for more information.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-%>
# JHipster Rust CI/CD - GitHub Actions
name: Application CI
on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: <%= baseName %> build and test
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]')"
    timeout-minutes: 30
<%_ if (devDatabaseTypePostgresql || devDatabaseTypeMysql || devDatabaseTypeMongodb) { _%>

    services:
<%_ if (devDatabaseTypePostgresql) { _%>
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: <%= baseName %>
          POSTGRES_PASSWORD: <%= baseName %>
          POSTGRES_DB: <%= baseName %>
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
<%_ } _%>
<%_ if (devDatabaseTypeMysql) { _%>
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: <%= baseName %>
          MYSQL_USER: <%= baseName %>
          MYSQL_PASSWORD: <%= baseName %>
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
<%_ } _%>
<%_ if (devDatabaseTypeMongodb) { _%>
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
<%_ } _%>
<%_ } _%>

    steps:
      - uses: actions/checkout@v4
<%_ if (messageBrokerKafka) { _%>

      - name: Install build dependencies for rdkafka
        run: sudo apt-get update && sudo apt-get install -y cmake
<%_ } _%>

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            server/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # TODO: Uncomment once generated code passes cargo fmt
      # - name: Check formatting
      #   run: cargo fmt --all -- --check
      #   working-directory: server

      - name: Clippy linting
        run: cargo clippy --all-targets -- -D warnings
        working-directory: server

      - name: Build
        run: cargo build --release
        working-directory: server

      - name: Run tests
<%_ if (devDatabaseTypePostgresql || devDatabaseTypeMysql) { _%>
        # Use single thread for database tests to avoid parallel migration conflicts
        run: cargo test -- --test-threads=1
<%_ } else { _%>
        run: cargo test
<%_ } _%>
        working-directory: server
<%_ if (devDatabaseTypePostgresql) { _%>
        env:
          DATABASE_URL: postgres://<%= baseName %>:<%= baseName %>@localhost:5432/<%= baseName %>
<%_ } else if (devDatabaseTypeMysql) { _%>
        env:
          DATABASE_URL: mysql://<%= baseName %>:<%= baseName %>@localhost:3306/<%= baseName %>
<%_ } else if (devDatabaseTypeMongodb) { _%>
        env:
          MONGODB_URI: mongodb://localhost:27017/<%= baseName %>
<%_ } _%>
<%_ if (ciCdIntegrations && ciCdIntegrations.includes('sonar')) { _%>

      - name: Analyze code with SonarQube
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -n "$SONAR_TOKEN" ]; then
            echo "Running SonarQube analysis..."
            # Add your sonar-scanner command here
            # sonar-scanner -Dsonar.projectKey=<%= baseName %> -Dsonar.sources=server/src
          else
            echo "No SONAR_TOKEN, skipping SonarQube analysis..."
          fi
<%_ } _%>
<%_ if (ciCdIntegrations && ciCdIntegrations.includes('publishDocker')) { _%>

  docker:
    name: Build and Push Docker Image
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: <%= dockerImage || baseName %>
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
<%_ } _%>
