<%#
 Copyright 2024 the original author or authors from the JHipster project.

 This file is part of the JHipster project, see https://www.jhipster.tech/
 for more information.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-%>
# JHipster Rust CI/CD - GitLab CI

image: rust:latest

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/
    - server/target/

stages:
  - lint
  - build
  - test
<%_ if (ciCdIntegrations && ciCdIntegrations.includes('publishDocker')) { _%>
  - package
<%_ } _%>

<%_ if (devDatabaseTypePostgresql) { _%>
.postgres-service: &postgres-service
  services:
    - name: postgres:15
      alias: postgres
  variables:
    POSTGRES_USER: <%= baseName %>
    POSTGRES_PASSWORD: <%= baseName %>
    POSTGRES_DB: <%= baseName %>
    DATABASE_URL: postgres://<%= baseName %>:<%= baseName %>@postgres:5432/<%= baseName %>

<%_ } _%>
<%_ if (devDatabaseTypeMysql) { _%>
.mysql-service: &mysql-service
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: <%= baseName %>
    MYSQL_USER: <%= baseName %>
    MYSQL_PASSWORD: <%= baseName %>
    DATABASE_URL: mysql://<%= baseName %>:<%= baseName %>@mysql:3306/<%= baseName %>

<%_ } _%>
<%_ if (devDatabaseTypeMongodb) { _%>
.mongodb-service: &mongodb-service
  services:
    - name: mongo:7
      alias: mongodb
  variables:
    MONGODB_URI: mongodb://mongodb:27017/<%= baseName %>

<%_ } _%>
lint:format:
  stage: lint
  script:
    - rustup component add rustfmt
    - cd server && cargo fmt --all -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

lint:clippy:
  stage: lint
  script:
    - rustup component add clippy
    - cd server && cargo clippy --all-targets --all-features -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:
  stage: build
  script:
    - cd server && cargo build --release
  artifacts:
    paths:
      - server/target/release/
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:
  stage: test
<%_ if (devDatabaseTypePostgresql) { _%>
  <<: *postgres-service
<%_ } else if (devDatabaseTypeMysql) { _%>
  <<: *mysql-service
<%_ } else if (devDatabaseTypeMongodb) { _%>
  <<: *mongodb-service
<%_ } _%>
  script:
    - cd server && cargo test --all-features
  artifacts:
    reports:
      junit: server/target/nextest/ci/junit.xml
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
<%_ if (ciCdIntegrations && ciCdIntegrations.includes('sonar')) { _%>

sonar:
  stage: test
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner -Dsonar.projectKey=<%= baseName %> -Dsonar.sources=server/src
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
<%_ } _%>
<%_ if (ciCdIntegrations && ciCdIntegrations.includes('publishDocker')) { _%>

docker:build:
  stage: package
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd server && docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
<%_ } _%>
